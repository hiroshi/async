version: '3.7'
x-app: &app
  # image: ruby:2.6.3
  build: .
  volumes:
  - .:/app
  - bundle:/usr/local/bundle
  - node_modules:/app/node_modules
  depends_on:
  - postgres
  - socket-proxy
services:
  app:
    <<: *app
    command: ['rails', 's', '-b', '0.0.0.0', '-p', '5010']
    environment:
    - SOCKET_PROXY_URL=http://sp.async.lvh.me:3200/
    - POSTGRES_HOST=postgres
    - WEBPACKER_DEV_SERVER_HOST=webpacker
    ports:
    - 5010:5010
    tmpfs:
    - /app/tmp/pids
    networks:
      default:
        aliases:
        - async.lvh.me
  webpacker:
    <<: *app
    command: ['bin/webpack-dev-server']
    environment:
    - SOCKET_PROXY_URL=http://sp.async.lvh.me:3200/
    ports:
    - 3035:3035
  spring:
    <<: *app
    command: ['bin/spring', 'server']
    ports:
    - 5020:5020
  postgres:
    image: postgres:11.3-alpine
    ports:
    - 5432:5432
    volumes:
    - pgdata:/var/lib/postgresql/data
  socket-proxy:
    image: hiroshi3110/socket-proxy
    environment:
    - PORT=3200
    ports:
    - 3200:3200
    networks:
      default:
        aliases:
        - sp.async.lvh.me
volumes:
  bundle:
  node_modules:
  pgdata:
